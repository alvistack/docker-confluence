diff -urp a/opt/atlassian/confluence/bin/setenv.sh b/opt/atlassian/confluence/bin/setenv.sh
--- a/opt/atlassian/confluence/bin/setenv.sh	2018-04-26 20:55:11.819281826 +0800
+++ b/opt/atlassian/confluence/bin/setenv.sh	2018-04-26 20:59:56.375137220 +0800
@@ -14,16 +14,16 @@ export CATALINA_PID
 
 PRGDIR=`dirname "$0"`
 if [ -z "$CATALINA_BASE" ]; then
-  if [ -z "$CATALINA_HOME" ]; then
-    LOGBASE=$PRGDIR
-    LOGTAIL=..
-  else
-    LOGBASE=$CATALINA_HOME
-    LOGTAIL=.
-  fi
+    if [ -z "$CATALINA_HOME" ]; then
+        LOGBASE=$PRGDIR
+        LOGTAIL=..
+    else
+        LOGBASE=$CATALINA_HOME
+        LOGTAIL=.
+    fi
 else
-  LOGBASE=$CATALINA_BASE
-  LOGTAIL=.
+    LOGBASE=$CATALINA_BASE
+    LOGTAIL=.
 fi
 
 PUSHED_DIR=`pwd`
@@ -37,24 +37,24 @@ echo "Server startup logs are located in
 # IMPORTANT NOTE: Only set JAVA_HOME or JRE_HOME above this line
 # Get standard Java environment variables
 if $os400; then
-  # -r will Only work on the os400 if the files are:
-  # 1. owned by the user
-  # 2. owned by the PRIMARY group of the user
-  # this will not work if the user belongs in secondary groups
-  . "$CATALINA_HOME"/bin/setjre.sh
-else
-  if [ -r "$CATALINA_HOME"/bin/setjre.sh ]; then
+    # -r will Only work on the os400 if the files are:
+    # 1. owned by the user
+    # 2. owned by the PRIMARY group of the user
+    # this will not work if the user belongs in secondary groups
     . "$CATALINA_HOME"/bin/setjre.sh
-  else
-    echo "Cannot find $CATALINA_HOME/bin/setjre.sh"
-    echo "This file is needed to run this program"
-    exit 1
-  fi
+else
+    if [ -r "$CATALINA_HOME"/bin/setjre.sh ]; then
+        . "$CATALINA_HOME"/bin/setjre.sh
+    else
+        echo "Cannot find $CATALINA_HOME/bin/setjre.sh"
+        echo "This file is needed to run this program"
+        exit 1
+    fi
 fi
 
 echo "---------------------------------------------------------------------------"
 echo "Using Java: $JRE_HOME/bin/java"
-CONFLUENCE_CONTEXT_PATH=`$JRE_HOME/bin/java -jar $CATALINA_HOME/bin/confluence-context-path-extractor.jar $CATALINA_HOME`
+CONFLUENCE_CONTEXT_PATH=${CATALINA_CONTEXT_PATH:-}
 export CONFLUENCE_CONTEXT_PATH
 $JRE_HOME/bin/java -jar $CATALINA_HOME/bin/synchrony-proxy-watchdog.jar $CATALINA_HOME
 echo "---------------------------------------------------------------------------"
@@ -65,12 +65,17 @@ CATALINA_OPTS="-XX:-PrintGCDetails -XX:+
 CATALINA_OPTS="-Xloggc:$LOGBASEABS/logs/gc-`date +%F_%H-%M-%S`.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=2M ${CATALINA_OPTS}"
 CATALINA_OPTS="-XX:G1ReservePercent=20 ${CATALINA_OPTS}"
 CATALINA_OPTS="-Djava.awt.headless=true ${CATALINA_OPTS}"
-CATALINA_OPTS="-Datlassian.plugins.enable.wait=300 ${CATALINA_OPTS}"
-CATALINA_OPTS="-Xms1024m -Xmx1024m -XX:+UseG1GC ${CATALINA_OPTS}"
+CATALINA_OPTS="-D${JVM_SUPPORT_RECOMMENDED_ARGS:-"-Datlassian.plugins.enable.wait=300"} ${CATALINA_OPTS}"
+CATALINA_OPTS="-Xms${JVM_MINIMUM_MEMORY:-1024m} -Xmx${JVM_MAXIMUM_MEMORY:-1024m} -XX:+UseG1GC ${CATALINA_OPTS}"
 CATALINA_OPTS="-Dsynchrony.enable.xhr.fallback=true ${CATALINA_OPTS}"
 CATALINA_OPTS="-Dorg.apache.tomcat.websocket.DEFAULT_BUFFER_SIZE=32768 ${CATALINA_OPTS}"
 CATALINA_OPTS="${START_CONFLUENCE_JAVA_OPTS} ${CATALINA_OPTS}"
-CATALINA_OPTS="-Dconfluence.context.path=${CONFLUENCE_CONTEXT_PATH} ${CATALINA_OPTS}"
+CATALINA_OPTS="-Dconfluence.home=${CONFLUENCE_HOME:-/var/atlassian/application-data/confluence} ${CATALINA_OPTS}"
+CATALINA_OPTS="-Dcatalina.connector.proxyName=${CATALINA_CONNECTOR_PROXYNAME:-} ${CATALINA_OPTS}"
+CATALINA_OPTS="-Dcatalina.connector.proxyPort=${CATALINA_CONNECTOR_PROXYPORT:-} ${CATALINA_OPTS}"
+CATALINA_OPTS="-Dcatalina.connector.scheme=${CATALINA_CONNECTOR_SCHEME:-http} ${CATALINA_OPTS}"
+CATALINA_OPTS="-Dcatalina.connector.secure=${CATALINA_CONNECTOR_SECURE:-false} ${CATALINA_OPTS}"
+CATALINA_OPTS="-Dcatalina.context.path=${CATALINA_CONTEXT_PATH} ${CATALINA_OPTS}"
 CATALINA_OPTS="-XX:ReservedCodeCacheSize=256m -XX:+UseCodeCacheFlushing ${CATALINA_OPTS}"
 
 
Only in b/opt/atlassian/confluence/bin: setenv.sh.orig
diff -urp a/opt/atlassian/confluence/conf/server.xml b/opt/atlassian/confluence/conf/server.xml
--- a/opt/atlassian/confluence/conf/server.xml	2018-04-26 20:55:01.154264010 +0800
+++ b/opt/atlassian/confluence/conf/server.xml	2018-04-26 20:55:27.011528433 +0800
@@ -8,6 +8,7 @@
          ==============================================================================================================
         -->
         <Connector port="8090" connectionTimeout="20000" redirectPort="8443"
+                   proxyName="${catalina.connector.proxyName}" proxyPort="${catalina.connector.proxyPort}" scheme="${catalina.connector.scheme}" secure="${catalina.connector.secure}"
                    maxThreads="48" minSpareThreads="10"
                    enableLookups="false" acceptCount="10" debug="0" URIEncoding="UTF-8"
                    protocol="org.apache.coyote.http11.Http11NioProtocol"/>
@@ -74,13 +75,13 @@
 
         <Engine name="Standalone" defaultHost="localhost" debug="0">
             <Host name="localhost" debug="0" appBase="webapps" unpackWARs="true" autoDeploy="false" startStopThreads="4">
-                <Context path="" docBase="../confluence" debug="0" reloadable="false" useHttpOnly="true">
+                <Context path="${catalina.context.path}" docBase="../confluence" debug="0" reloadable="false" useHttpOnly="true">
                     <!-- Logging configuration for Confluence is specified in confluence/WEB-INF/classes/log4j.properties -->
                     <Manager pathname=""/>
                     <Valve className="org.apache.catalina.valves.StuckThreadDetectionValve" threshold="60"/>
                 </Context>
 
-                <Context path="${confluence.context.path}/synchrony-proxy" docBase="../synchrony-proxy" debug="0"
+                <Context path="${catalina.context.path}/synchrony-proxy" docBase="../synchrony-proxy" debug="0"
                          reloadable="false" useHttpOnly="true">
                     <Valve className="org.apache.catalina.valves.StuckThreadDetectionValve" threshold="60"/>
                 </Context>
